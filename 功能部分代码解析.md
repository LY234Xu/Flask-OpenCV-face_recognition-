---

 1. 初始化相关函数
 `load_reference_image(path)`
python
def load_reference_image(path):
    image = cv2.imread(path)   读取图像文件
    rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)   转换颜色空间
    face_locations = face_recognition.face_locations(rgb)   检测人脸位置
    return face_recognition.face_encodings(rgb, face_locations)0   生成128维特征编码
功能对应需求：2.1人脸识别功能 - 特征编码  
作用：加载单张已知人脸图像并生成特征编码  
关键点：  
- 使用OpenCV读取图像后需转换为RGB格式（face_recognition库的要求）  
- 若图像中无人脸会抛出异常（需求5.2异常处理）  
- 返回128维特征向量用于后续比对

---

 `init_camera()`
python
def init_camera():
    picam2 = Picamera2()
    config = picam2.create_preview_configuration(
        main={"size": (640, 480), "format": "BGR888"},   分辨率配置
        controls={
            "FrameDurationLimits": (33333, 66666),   30fps
            "AwbMode": 0   自动白平衡
        }
    )
    picam2.configure(config)
    picam2.start()
    return picam2
功能对应需求：3.1硬件需求 - 树莓派相机控制  
作用：初始化相机硬件参数  
关键参数：  
- 640x480分辨率（满足3.3性能需求）  
- 30fps帧率控制  
- BGR888格式输出（与OpenCV兼容）

---

 2. 人脸管理函数
 `save_new_face(frame, face_location, name)`
python
def save_new_face(frame, face_location, name):
    top, right, bottom, left = face_location
    face_image = frametop:bottom, left:right   截取人脸区域
    face_image_rgb = cv2.cvtColor(face_image, cv2.COLOR_BGR2RGB)
    os.makedirs('faces', exist_ok=True)   自动创建目录
    image_path = os.path.join('faces', f'{name}.jpg')
    cv2.imwrite(image_path, face_image_rgb)   保存为JPEG
    return load_reference_image(image_path)   返回新编码
功能对应需求：2.2人脸管理功能 - 新人脸保存  
工作流程：  
1. 从视频帧中裁剪人脸区域  
2. 自动创建faces目录（需求5.3资源管理）  
3. 以指定名称保存为.jpg文件  
4. 生成新人脸编码并返回（实现需求5.1可扩展性）

---

 `load_all_known_faces()`
python
def load_all_known_faces():
    known_encodings = 
    known_names = 
    for filename in os.listdir('faces'):
        if filename.endswith('.jpg'):
            name = os.path.splitext(filename)0
            try:
                encoding = load_reference_image(os.path.join('faces', filename))
                known_encodings.append(encoding)
                known_names.append(name)
            except Exception as e:
                print(f"Error loading {filename}: {e}")   错误处理
    return known_encodings, known_names
功能对应需求：2.2人脸管理功能 - 已知人脸加载  
特点：  
- 自动遍历faces目录下所有.jpg文件  
- 异常捕获机制（需求5.2异常处理）  
- 返回编码列表和对应名称列表  
- 实现动态加载（需求6.1性能优化基础）

---

 3. 主逻辑函数
 `main()`
核心流程对应需求：4.系统流程  
python
 初始化阶段
1. 加载命令行参数（需求2.3用户交互 - 模式选择）
2. 调用load_all_known_faces()加载已知人脸
3. 初始化相机硬件

 主循环
while True:
     视频采集
    frame = camera.capture_array()   获取视频帧
    
     人脸检测
    small_frame = cv2.resize(frame_rgb, fx=SCALE_FACTOR)   降采样提高性能
    face_locations = face_recognition.face_locations(small_frame)
    face_encodings = face_recognition.face_encodings(small_frame, face_locations)
    
     人脸匹配（需求2.1）
    distances = face_recognition.face_distance(known_encodings, face_encoding)
    min_distance = np.min(distances)
    match_index = np.argmin(distances)
    
     结果显示（需求2.3）
    cv2.rectangle(frame, (left, top), (right, bottom), color, 2)
    cv2.putText(frame, f"{name} ({min_distance:.2f})", ...)
    
     模式2特殊处理（需求2.2）
    if choice == '2' and all_unknown:
        if time.time() - unknown_start_time >= TIMEOUT:
            cv2.imwrite('temp_frame.jpg', frame)   保存临时文件
            webbrowser.open('http://127.0.0.1:5000/save_face')   打开网页界面
    
     退出机制
    if cv2.waitKey(1) & 0xFF == ord('q'):   按q键退出
        break

---

 4. 关键实现细节
1. 降采样处理（SCALE_FACTOR=0.5）  
   - 在检测前缩小图像尺寸，大幅提升处理速度（满足3.3性能需求）

2. 匹配阈值（THRESHOLD=0.5）  
   - 通过实验调整的欧氏距离阈值，小于该值判定为同一人

3. 定时保存机制（TIMEOUT=3）  
   - 检测到未知人脸持续3秒后才触发保存（防止误操作）

4. 资源释放  
   python
   finally:
       camera.stop()
       cv2.destroyAllWindows()   实现需求5.3资源管理

5. Web集成  
   - 通过webbrowser打开本地Web服务，为后续扩展网页管理界面预留接口（对应需求6.3用户体验改进）

---

 5. 与需求文档的对应关系
 代码实现  对应需求条目  实现说明 

 face_distance计算  2.1人脸匹配  使用欧氏距离进行相似度度量 
 命令行参数解析  2.3模式选择  sys.argv获取运行参数 
 自动创建faces目录  5.3资源管理  os.makedirs自动处理目录 
 异常捕获块  5.2异常处理  trycatch保护关键操作 
 30fps配置  3.3性能需求  FrameDurationLimits参数控制 

需要进一步优化的地方可参考需求文档第6章（如添加活体检测、多人脸优化等）。
